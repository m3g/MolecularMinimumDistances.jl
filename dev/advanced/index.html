<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced use · MolecularMinimumDistances.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img class="docs-light-only" src="../assets/logo.svg" alt="MolecularMinimumDistances.jl logo"/><img class="docs-dark-only" src="../assets/logo-dark.svg" alt="MolecularMinimumDistances.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">MolecularMinimumDistances.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../basic/">Basic use</a></li><li class="is-active"><a class="tocitem" href>Advanced use</a><ul class="internal"><li><a class="tocitem" href="#System-build-and-update"><span>System build and update</span></a></li><li><a class="tocitem" href="#Updating-positions"><span>Updating positions</span></a></li><li><a class="tocitem" href="#Updating-the-cutoff,-unitcell-and-parallel-flag"><span>Updating the cutoff, unitcell and parallel flag</span></a></li><li><a class="tocitem" href="#Index-of-molecules"><span>Index of molecules</span></a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Advanced use</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced use</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/m3g/MolecularMinimumDistances.jl/blob/main/docs/src/advanced.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Advanced-usage"><a class="docs-heading-anchor" href="#Advanced-usage">Advanced usage</a><a id="Advanced-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-usage" title="Permalink"></a></h1><h2 id="System-build-and-update"><a class="docs-heading-anchor" href="#System-build-and-update">System build and update</a><a id="System-build-and-update-1"></a><a class="docs-heading-anchor-permalink" href="#System-build-and-update" title="Permalink"></a></h2><p>If the molecular minimum distances will be computed many times for similar systems, it is possible to construct the system and update its properties. The use of the interface of <code>CellListMap.PeriodicSystems</code> is required (requires <code>CellListMap</code> version <code>0.7.24</code> or greater). </p><p>For example, let us build one system with a protein and water:</p><pre><code class="language-julia-repl hljs">julia&gt; using MolecularMinimumDistances, PDBTools

julia&gt; system = MolecularMinimumDistances.download_example();

julia&gt; protein = coor(system, &quot;protein&quot;);

julia&gt; water = coor(system, &quot;water&quot;);</code></pre><p>We now build the <code>CrossPairs</code>  type of system, instead of calling the <code>minimum_distances</code> function directly:</p><pre><code class="language-julia-repl hljs">julia&gt; sys = CrossPairs(
           xpositions=water, # solvent
           ypositions=protein, # solute
           xn_atoms_per_molecule=3,
           cutoff=12.0,
           unitcell=[84.48, 84.48, 84.48]
       )
CrossPairs system with:

Number of atoms of set x: 58014
Number of molecules in set x: 19338
Number of atoms of target structure y: 1463
Cutoff: 12.0
unitcell: [84.48, 0.0, 0.0, 0.0, 84.48, 0.0, 0.0, 0.0, 84.48]</code></pre><p>Now <code>sys</code>  contains the necessary arrays for computing the list of minimum distances. We use now the <code>minimum_distances!</code>  function (with the <code>!</code>), to update that list:</p><pre><code class="language-julia-repl hljs">julia&gt; minimum_distances!(sys)
19338-element Vector{MinimumDistance{Float64}}:
 MinimumDistance{Float64}(false, 0, 0, Inf)
 MinimumDistance{Float64}(false, 0, 0, Inf)
 MinimumDistance{Float64}(false, 0, 0, Inf)
 ⋮
 MinimumDistance{Float64}(true, 58011, 383, 10.24673074692606)
 MinimumDistance{Float64}(false, 0, 0, Inf)</code></pre><p>The system can be now updated: the positions, cutoff, or unitcell can be modified, with the  following interfaces:</p><h2 id="Updating-positions"><a class="docs-heading-anchor" href="#Updating-positions">Updating positions</a><a id="Updating-positions-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-positions" title="Permalink"></a></h2><p>To update the positions, modify the <code>sys.xpositions</code> (or <code>ypositions</code>)  array. We will boldy demonstrate this by making the first atom of the <code>x</code> set to be close to the first atom of the protein, and recomputing the distances:</p><pre><code class="language-julia-repl hljs">julia&gt; using StaticArrays

julia&gt; sys.xpositions[2] = sys.ypositions[1] + SVector(1.0,0.0,0.0);

julia&gt; minimum_distances!(sys)
19338-element Vector{MinimumDistance{Float64}}:
 MinimumDistance{Float64}(true, 2, 4, 0.9202923448556931)
 MinimumDistance{Float64}(false, 0, 0, Inf)
 MinimumDistance{Float64}(false, 0, 0, Inf)
 ⋮
 MinimumDistance{Float64}(true, 58011, 383, 10.24673074692606)
 MinimumDistance{Float64}(false, 0, 0, Inf)</code></pre><h2 id="Updating-the-cutoff,-unitcell-and-parallel-flag"><a class="docs-heading-anchor" href="#Updating-the-cutoff,-unitcell-and-parallel-flag">Updating the cutoff, unitcell and parallel flag</a><a id="Updating-the-cutoff,-unitcell-and-parallel-flag-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-the-cutoff,-unitcell-and-parallel-flag" title="Permalink"></a></h2><p>The <code>cutoff</code>, <code>unitcell</code> and <code>parallel</code> data of the <code>sys</code> objects can be modified  directly. For example:</p><pre><code class="language-julia-repl hljs">julia&gt; sys
CrossPairs system with:

Number of atoms of set x: 58014
Number of molecules in set x: 19338
Number of atoms of target structure y: 1463
Cutoff: 15.0
unitcell: [100.0, 0.0, 0.0, 0.0, 100.0, 0.0, 0.0, 0.0, 100.0]

julia&gt; sys.cutoff = 10.0
10.0

julia&gt; sys.unitcell = [84.4, 84.4, 84.4]
3-element Vector{Float64}:
 84.4
 84.4
 84.4

julia&gt; sys.parallel = false
false

julia&gt; sys
CrossPairs system with:

Number of atoms of set x: 58014
Number of molecules in set x: 19338
Number of atoms of target structure y: 1463
Cutoff: 10.0
unitcell: [84.4, 0.0, 0.0, 0.0, 84.4, 0.0, 0.0, 0.0, 84.4]</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>It is not possible to update the <code>unitcell</code> from a Orthorhombic to a general Triclinic cell. If the system will be Triclinic at any moment, the <code>unitcell</code> must be initialized with the full matrix instead of a  vector of sides.</p></div></div><h2 id="Index-of-molecules"><a class="docs-heading-anchor" href="#Index-of-molecules">Index of molecules</a><a id="Index-of-molecules-1"></a><a class="docs-heading-anchor-permalink" href="#Index-of-molecules" title="Permalink"></a></h2><p>Additionally, the low level interface allows the definition of more general groups of particles, in the sense that &quot;molecule&quot; can have different number of atoms in the same set. Therefore, one needs to provide <em>a function</em> that returns the index of the molecule of each atom, given the index of the atom. </p><p>Briefly, if a set of atoms belong to molecules of the same number of atoms, one can compute the index of each molecule using</p><pre><code class="language-julia hljs">mol_indices(i,n) = div((i - 1), n) + 1</code></pre><p>where <code>i</code> is the atom index in the array of coordinates, and <code>n</code> is the number of atoms per molecule. This is the default assumed in the basic interface, and can be called with:</p><pre><code class="language-julia-repl hljs">julia&gt; using StaticArrays

julia&gt; x = rand(SVector{3,Float64},9); # 3 water molecules

julia&gt; mol_indices(2,3) # second atom belongs to first molecule
1

julia&gt; mol_indices(4,3) # fourth atom belongs to second molecule
2</code></pre><p>Typically, as we will show, this function will be used for setting up molecule indexes.</p><p>However, more general indexing can be used. For instance, let us suppose that the 9 atoms of the <code>x</code> array of coordinates above belong to <code>2</code> molecules, with <code>4</code> and <code>5</code> atoms each. Then, we could define, for example:</p><pre><code class="language-julia-repl hljs">julia&gt; my_mol_indices(i) = i &lt;= 4 ? 1 : 2
my_mol_indices (generic function with 1 method)

julia&gt; my_mol_indices(4)
1

julia&gt; my_mol_indices(5)
2</code></pre><p>Since the function can close-over an array of molecular indexes, the definition can be completely general, that is:</p><pre><code class="language-julia-repl hljs">julia&gt; molecular_indexes = [ 1, 3, 3, 2, 2, 1, 3, 1, 2 ];

julia&gt; my_mol_indices(i) = molecular_indexes[i]
my_mol_indices (generic function with 1 method)

julia&gt; my_mol_indices(1)
1

julia&gt; my_mol_indices(5)
2</code></pre><p>In summary, this function that given the index of the atom returns the index of the corresponding molecule must be provided in the advanced interface, and typically will be just a closure around the number of atoms per molecule, using the already available <code>mol_indices</code> function. </p><h4 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h4><p>Let us mix water and TMAO molecules in the same set, and use a general function to compute the indices of the molecules of each atom: </p><pre><code class="language-julia-repl hljs">julia&gt; system = MolecularMinimumDistances.download_example();

julia&gt; protein = coor(system, &quot;protein&quot;);

julia&gt; tmao_and_water = select(system, &quot;resname TMAO or resname TIP3&quot;)
   Array{Atoms,1} with 60548 atoms with fields:
   index name resname chain   resnum  residue        x        y        z  beta occup model segname index_pdb
    1479    N    TMAO     A        1      120  -23.532   -9.347   19.545  0.00  1.00     1    TMAO      1479
    1480   C1    TMAO     A        1      120  -23.567   -7.907   19.381  0.00  1.00     1    TMAO      1480
    1481   C2    TMAO     A        1      120  -22.498   -9.702   20.497  0.00  1.00     1    TMAO      1481
                                                       ⋮ 
   62024  OH2    TIP3     C     9339    19638   13.485   -4.534  -34.438  0.00  1.00     1    WAT2     62024
   62025   H1    TIP3     C     9339    19638   13.218   -3.647  -34.453  0.00  1.00     1    WAT2     62025
   62026   H2    TIP3     C     9339    19638   12.618   -4.977  -34.303  0.00  1.00     1    WAT2     62026

julia&gt; findfirst(at -&gt; at.resname == &quot;TIP3&quot;, tmao_and_water)
2535</code></pre><p>Thus, the <code>tmao_and_water</code> atom array has two different types of molecules, TMAO with 14 atoms, and water with 3 atoms.  The first atom of a water molecule is atom <code>2535</code> of the array. We extract the coordinates of the atoms with:</p><pre><code class="language-julia-repl hljs">julia&gt; solvent = coor(tmao_and_water)
60548-element Vector{SVector{3, Float64}}:
 [-23.532, -9.347, 19.545]
 [-23.567, -7.907, 19.381]
 [-22.498, -9.702, 20.497]
 ⋮
 [13.218, -3.647, -34.453]
 [12.618, -4.977, -34.303]</code></pre><p>And now we define a function that, given the index of the atom, returns the molecule to which it belongs:</p><pre><code class="language-julia-repl hljs">julia&gt; function mol_indices(i) 
           if i &lt; 2535 # TMAO (14 atoms per molecule) 
               div(i-1,14) + 1 
           else # water (3 atoms per molecule)
               mol_indices(2534) + div(i-2534-1,3) + 1
           end
       end
mol_indices (generic function with 1 method)</code></pre><p>The function above computes the molecular indices for TMAO in the standard way, and computes the water  molecular indices by first summing the molecule index of the last TMAO molecule, and subtracting from the atomic index of water the last index of the last TMAO atom. We can test this: </p><pre><code class="language-julia-repl hljs">julia&gt; mol_indices(14) # last atom of first TMAO
1

julia&gt; mol_indices(15) # first atom of second TMAO
2

julia&gt; mol_indices(2534) # last atom of last TMAO
181

julia&gt; mol_indices(2535) # first atom of first water
182

julia&gt; mol_indices(2537) # last atom of first water
182

julia&gt; mol_indices(2538) # first atom of second water
183</code></pre><p>With this function, we can construct the system using it instead of the <code>xn_atoms_per_molecule</code> integer variable, to obtain the solvation of the protein by both TMAO and water in a single run:</p><pre><code class="language-julia-repl hljs">julia&gt; sys = CrossPairs(
           xpositions=solvent, # solvent = coor(tmao_and_water)
           ypositions=protein, # solute
           xmol_indices = mol_indices,
           cutoff=12.0,
           unitcell=[84.48, 84.48, 84.48]
       )
CrossPairs system with:

Number of atoms of set x: 60548
Number of molecules in set x: 19519
Number of atoms of target structure y: 1463
Cutoff: 12.0
unitcell: [84.48, 0.0, 0.0, 0.0, 84.48, 0.0, 0.0, 0.0, 84.48]</code></pre><p>As we can see, the number of molecules is correct (the sum of the number of water and tmao molecules). And the list of minimum distances will retrive the information of the closest protein atom to all solvent molecules of the set:</p><pre><code class="language-julia-repl hljs">julia&gt; minimum_distances!(sys)
19519-element Vector{MinimumDistance{Float64}}:
 MinimumDistance{Float64}(false, 0, 0, Inf)
 MinimumDistance{Float64}(false, 0, 0, Inf)
 MinimumDistance{Float64}(false, 0, 0, Inf)
 ⋮
 MinimumDistance{Float64}(true, 60545, 383, 10.24673074692606)
 MinimumDistance{Float64}(false, 0, 0, Inf)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../basic/">« Basic use</a><a class="docs-footer-nextpage" href="../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Friday 31 March 2023 12:51">Friday 31 March 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
